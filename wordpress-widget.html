<!-- 
WIDGET CHATBOT FISCALE PER WORDPRESS

ISTRUZIONI INSTALLAZIONE:
1. Vai in WordPress ‚Üí Aspetto ‚Üí Personalizza ‚Üí HTML/CSS Aggiuntivo
   OPPURE
2. Usa un plugin come "Insert Headers and Footers"
3. Incolla questo codice nella sezione HEAD o FOOTER

IMPORTANTE: Sostituisci "YOUR_BACKEND_URL" con l'URL del tuo backend
(es: https://tuo-chatbot.onrender.com)
-->

<style>
    /* Widget Chatbot Fiscale */
    .fiscal-chatbot-widget {
        position: fixed;
        bottom: 24px;
        right: 24px;
        z-index: 999999;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .fiscal-chat-button {
        width: 64px;
        height: 64px;
        border-radius: 50%;
        background: linear-gradient(135deg, #1e3a8a 0%, #dc2626 100%);
        border: none;
        cursor: pointer;
        box-shadow: 0 8px 32px rgba(30, 58, 138, 0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s;
        position: relative;
    }

    .fiscal-chat-button:hover {
        transform: scale(1.1);
        box-shadow: 0 12px 40px rgba(30, 58, 138, 0.4);
    }

    .fiscal-chat-button::after {
        content: '';
        position: absolute;
        width: 100%;
        height: 100%;
        border-radius: 50%;
        border: 2px solid #1e3a8a;
        animation: fiscal-pulse 2s infinite;
    }

    @keyframes fiscal-pulse {
        0% { transform: scale(1); opacity: 1; }
        100% { transform: scale(1.3); opacity: 0; }
    }

    .fiscal-chat-icon {
        font-size: 32px;
        transition: transform 0.3s;
    }

    .fiscal-chat-button.open .fiscal-chat-icon {
        transform: rotate(180deg);
    }

    .fiscal-chat-window {
        position: absolute;
        bottom: 80px;
        right: 0;
        width: 420px;
        max-width: calc(100vw - 40px);
        height: 600px;
        max-height: calc(100vh - 120px);
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.2);
        display: none;
        flex-direction: column;
        overflow: hidden;
        animation: fiscal-slideUp 0.3s ease-out;
    }

    @keyframes fiscal-slideUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .fiscal-chat-window.open {
        display: flex;
    }

    .fiscal-chat-header {
        background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
        color: white;
        padding: 20px;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .fiscal-chat-avatar {
        width: 48px;
        height: 48px;
        background: rgba(255,255,255,0.2);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
    }

    .fiscal-chat-info h3 {
        margin: 0 0 4px 0;
        font-size: 1.2rem;
        font-weight: 600;
    }

    .fiscal-chat-info p {
        margin: 0;
        font-size: 0.85rem;
        opacity: 0.9;
    }

    .fiscal-chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background: #f8fafc;
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .fiscal-message {
        display: flex;
        gap: 10px;
        animation: fiscal-messageSlide 0.3s ease-out;
    }

    @keyframes fiscal-messageSlide {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .fiscal-message.user {
        flex-direction: row-reverse;
    }

    .fiscal-message-avatar {
        width: 36px;
        height: 36px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        flex-shrink: 0;
    }

    .fiscal-message.bot .fiscal-message-avatar {
        background: linear-gradient(135deg, #1e3a8a 0%, #dc2626 100%);
    }

    .fiscal-message.user .fiscal-message-avatar {
        background: #64748b;
    }

    .fiscal-message-content {
        max-width: 75%;
        padding: 12px 16px;
        border-radius: 16px;
        font-size: 0.9rem;
        line-height: 1.5;
    }

    .fiscal-message.bot .fiscal-message-content {
        background: white;
        color: #0f172a;
        border: 1px solid #cbd5e1;
    }

    .fiscal-message.user .fiscal-message-content {
        background: #1e3a8a;
        color: white;
    }

    .fiscal-typing {
        display: none;
        gap: 10px;
    }

    .fiscal-typing.active {
        display: flex;
    }

    .fiscal-typing-dots {
        display: flex;
        gap: 4px;
        padding: 12px 16px;
        background: white;
        border: 1px solid #cbd5e1;
        border-radius: 16px;
    }

    .fiscal-typing-dot {
        width: 8px;
        height: 8px;
        background: #1e3a8a;
        border-radius: 50%;
        animation: fiscal-typing 1.4s infinite;
    }

    .fiscal-typing-dot:nth-child(2) {
        animation-delay: 0.2s;
    }

    .fiscal-typing-dot:nth-child(3) {
        animation-delay: 0.4s;
    }

    @keyframes fiscal-typing {
        0%, 60%, 100% {
            transform: translateY(0);
            opacity: 0.4;
        }
        30% {
            transform: translateY(-10px);
            opacity: 1;
        }
    }

    .fiscal-chat-input-container {
        padding: 16px;
        background: white;
        border-top: 1px solid #cbd5e1;
    }

    .fiscal-chat-input-wrapper {
        display: flex;
        gap: 8px;
        align-items: center;
        background: #f8fafc;
        border-radius: 14px;
        padding: 4px 4px 4px 12px;
        border: 1px solid #cbd5e1;
    }

    .fiscal-chat-input-wrapper:focus-within {
        border-color: #1e3a8a;
    }

    .fiscal-chat-input {
        flex: 1;
        border: none;
        background: transparent;
        padding: 10px 0;
        font-size: 0.9rem;
        color: #0f172a;
        outline: none;
    }

    .fiscal-send-button {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        background: #1e3a8a;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }

    .fiscal-send-button:hover:not(:disabled) {
        background: #dc2626;
    }

    .fiscal-send-button:disabled {
        opacity: 0.4;
        cursor: not-allowed;
    }

    .fiscal-sources {
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #e5e7eb;
        font-size: 0.8rem;
        color: #64748b;
    }

    .fiscal-source-link {
        display: inline-block;
        color: #1e3a8a;
        text-decoration: none;
        margin-top: 4px;
    }

    .fiscal-source-link:hover {
        text-decoration: underline;
    }
</style>

<div class="fiscal-chatbot-widget" id="fiscalChatbotWidget">
    <button class="fiscal-chat-button" id="fiscalChatToggle" aria-label="Apri assistente fiscale">
        <span class="fiscal-chat-icon">‚öñÔ∏è</span>
    </button>

    <div class="fiscal-chat-window" id="fiscalChatWindow">
        <div class="fiscal-chat-header">
            <div class="fiscal-chat-avatar">‚öñÔ∏è</div>
            <div class="fiscal-chat-info">
                <h3>Assistente Fiscale</h3>
                <p>Specializzato in fisco e previdenza</p>
            </div>
        </div>

        <div class="fiscal-chat-messages" id="fiscalChatMessages">
            <div class="fiscal-message bot">
                <div class="fiscal-message-avatar">‚öñÔ∏è</div>
                <div class="fiscal-message-content">
                    Ciao! Sono il tuo assistente per domande su fisco, previdenza e contabilit√†. 
                    Le mie risposte si basano su fonti istituzionali affidabili. Come posso aiutarti?
                </div>
            </div>

            <div class="fiscal-message bot fiscal-typing" id="fiscalTyping">
                <div class="fiscal-message-avatar">‚öñÔ∏è</div>
                <div class="fiscal-typing-dots">
                    <span class="fiscal-typing-dot"></span>
                    <span class="fiscal-typing-dot"></span>
                    <span class="fiscal-typing-dot"></span>
                </div>
            </div>
        </div>

        <div class="fiscal-chat-input-container">
            <div class="fiscal-chat-input-wrapper">
                <input 
                    type="text" 
                    class="fiscal-chat-input" 
                    id="fiscalChatInput" 
                    placeholder="Chiedi qualcosa su fisco o previdenza..."
                >
                <button class="fiscal-send-button" id="fiscalSendButton">
                    <svg width="20" height="20" fill="white" viewBox="0 0 24 24">
                        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    // CONFIGURAZIONE - MODIFICA QUESTO URL CON IL TUO BACKEND
    const BACKEND_URL = 'YOUR_BACKEND_URL'; // es: https://tuo-chatbot.onrender.com
    
    const chatToggle = document.getElementById('fiscalChatToggle');
    const chatWindow = document.getElementById('fiscalChatWindow');
    const chatMessages = document.getElementById('fiscalChatMessages');
    const chatInput = document.getElementById('fiscalChatInput');
    const sendButton = document.getElementById('fiscalSendButton');
    const typingIndicator = document.getElementById('fiscalTyping');

    let conversationHistory = [];

    // Toggle chat
    chatToggle.addEventListener('click', () => {
        chatWindow.classList.toggle('open');
        chatToggle.classList.toggle('open');
        if (chatWindow.classList.contains('open')) {
            chatInput.focus();
        }
    });

    // Aggiungi messaggio
    function addMessage(content, isUser = false, sources = null) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'fiscal-message ' + (isUser ? 'user' : 'bot');
        
        let sourcesHTML = '';
        if (sources && sources.length > 0) {
            sourcesHTML = `
                <div class="fiscal-sources">
                    üìö Fonti:
                    ${sources.map(s => `
                        <a href="${s.url}" target="_blank" class="fiscal-source-link">
                            ${s.title || s.domain}
                        </a>
                    `).join('<br>')}
                </div>
            `;
        }
        
        messageDiv.innerHTML = `
            <div class="fiscal-message-avatar">${isUser ? 'üë§' : '‚öñÔ∏è'}</div>
            <div class="fiscal-message-content">
                ${content}
                ${sourcesHTML}
            </div>
        `;
        
        chatMessages.insertBefore(messageDiv, typingIndicator);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Mostra/nascondi typing
    function showTyping() {
        typingIndicator.classList.add('active');
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function hideTyping() {
        typingIndicator.classList.remove('active');
    }

    // Invia messaggio
    async function sendMessage() {
        const message = chatInput.value.trim();
        if (!message) return;

        addMessage(message, true);
        chatInput.value = '';
        sendButton.disabled = true;
        showTyping();

        conversationHistory.push({
            role: 'user',
            content: message
        });

        try {
            const response = await fetch(`${BACKEND_URL}/api/chat`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: message,
                    conversationHistory: conversationHistory
                })
            });

            if (!response.ok) {
                throw new Error('Errore nella richiesta');
            }

            const data = await response.json();

            conversationHistory.push({
                role: 'assistant',
                content: data.response
            });

            hideTyping();
            addMessage(data.response, false, data.sources);

        } catch (error) {
            hideTyping();
            addMessage('‚ö†Ô∏è Si √® verificato un errore. Riprova pi√π tardi.', false);
            console.error('Errore chat:', error);
        } finally {
            sendButton.disabled = false;
            chatInput.focus();
        }
    }

    // Event listeners
    sendButton.addEventListener('click', sendMessage);
    chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });

    chatInput.addEventListener('input', () => {
        sendButton.disabled = chatInput.value.trim() === '';
    });
})();
</script>
